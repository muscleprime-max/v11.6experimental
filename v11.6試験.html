<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supplement Oracle v11.6 | ToS Feedback Edition</title>
    <style>
        :root {
            --primary: #0f172a; --accent: #3b82f6; --success: #10b981;
            --warning: #f59e0b; --danger: #ef4444; --bg: #f8fafc; --card: #ffffff;
            --lane-a: #ecfdf5; --lane-a-border: #059669;
            --lane-b: #fff7ed; --lane-b-border: #f97316;
            --lane-c: #f1f5f9; --lane-c-text: #64748b;
            --tab-active-bg: #e0f2fe; --tab-active-text: #0284c7;
        }

        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        body { background: var(--bg); color: var(--primary); padding: 15px; line-height: 1.6; margin: 0; }
        .container { max-width: 1000px; margin: 0 auto; background: var(--card); padding: 2rem; border-radius: 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }

        /* --- ToS Section (New) --- */
        .tos-summary { margin-bottom: 20px; border: 1px solid #cbd5e1; border-radius: 8px; background: #f1f5f9; font-size: 0.85rem; }
        .tos-summary summary { padding: 10px 15px; font-weight: bold; cursor: pointer; color: #475569; list-style: none; display: flex; justify-content: space-between; align-items: center; }
        .tos-summary summary::after { content: "â–¼"; font-size: 0.8em; }
        .tos-summary[open] summary::after { content: "â–²"; }
        .tos-content { padding: 15px; border-top: 1px solid #cbd5e1; background: #fff; border-radius: 0 0 8px 8px; color: #334155; }
        .tos-content h4 { margin: 10px 0 5px; font-size: 0.9rem; color: var(--primary); }
        .tos-content ul { margin: 0; padding-left: 20px; }
        .tos-content li { margin-bottom: 4px; }
        .tos-contact { margin-top: 15px; padding-top: 10px; border-top: 1px dashed #cbd5e1; font-size: 0.8rem; text-align: right; color: #64748b; }

        /* Header & Admin */
        h1 { text-align: center; margin-bottom: 0.2rem; font-size: 1.6rem; color: var(--primary); }
        .subtitle { text-align: center; color: #64748b; font-size: 0.85rem; margin-bottom: 0.5rem; }
        .supervisor { text-align: center; font-size: 0.9rem; font-weight: bold; color: var(--accent); margin-bottom: 2rem; background: #eff6ff; display: inline-block; padding: 4px 15px; border-radius: 20px; }
        
        .trainer-admin { margin-bottom: 30px; border: 2px dashed #cbd5e1; border-radius: 12px; padding: 20px; background: #f8fafc; display: none; }
        .trainer-admin.show { display: block; }
        .admin-header { font-weight: bold; color: #475569; margin-bottom: 15px; cursor: pointer; }
        .admin-controls { display: grid; gap: 10px; }
        .btn-copy { background: #475569; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; }

        /* Inputs */
        .section-title { font-size: 1.1rem; border-left: 5px solid var(--accent); padding-left: 12px; margin: 30px 0 15px; font-weight: bold; }
        .grid-inputs { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px; margin-bottom: 20px; }
        label { display: block; font-size: 0.75rem; font-weight: bold; color: #64748b; margin-bottom: 5px; }
        select, input[type="text"], input[type="number"], input[type="url"] { width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.95rem; }

        /* Check Cards */
        .pain-grid, .safety-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 8px; }
        .check-card { background: #f1f5f9; padding: 10px; border-radius: 8px; display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.8rem; border: 2px solid transparent; transition: 0.2s; user-select: none; }
        .check-card:hover { background: #e2e8f0; }
        .check-card:has(input:checked) { border-color: var(--accent); background: #eff6ff; color: var(--accent); font-weight: bold; }
        .check-card input { margin: 0; }

        /* Tab System */
        .tab-container { margin-bottom: 20px; }
        .tabs { display: flex; overflow-x: auto; gap: 5px; border-bottom: 2px solid #e2e8f0; padding-bottom: 5px; margin-bottom: 15px; scrollbar-width: none; }
        .tabs::-webkit-scrollbar { display: none; }
        .tab-btn { padding: 8px 15px; border: none; background: none; font-size: 0.85rem; font-weight: bold; color: #64748b; cursor: pointer; white-space: nowrap; border-radius: 20px; transition: 0.2s; }
        .tab-btn.active { background: var(--tab-active-bg); color: var(--tab-active-text); }
        .tab-content { display: none; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 8px; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: grid; }
        .taken-card { font-size: 0.8rem; padding: 8px; background: #fff; border: 1px solid #e2e8f0; }
        .taken-card:has(input:checked) { border-color: var(--success); background: #ecfdf5; color: var(--success); font-weight: bold; }

        /* Advanced Settings */
        .advanced-settings { margin-top: 15px; border: 1px solid #e2e8f0; border-radius: 10px; overflow: hidden; }
        .advanced-summary { padding: 10px 15px; background: #f8fafc; font-size: 0.8rem; cursor: pointer; font-weight: bold; color: #64748b; display: flex; justify-content: space-between; }
        .advanced-content { padding: 15px; display: none; background: #fff; border-top: 1px solid #e2e8f0; grid-template-columns: 1fr 1fr; gap: 20px; }
        .advanced-content.show { display: grid; }

        /* Actions */
        .disclaimer-box { margin-top: 30px; padding: 15px; background: #fff7ed; border: 1px solid #ffedd5; border-radius: 8px; font-size: 0.85rem; color: #9a3412; }
        .btn-analyze { width: 100%; padding: 18px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: bold; cursor: pointer; margin-top: 10px; transition: 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-analyze:disabled { background: #cbd5e1; cursor: not-allowed; }
        .btn-analyze:hover:not(:disabled) { background: var(--accent); transform: translateY(-2px); }

        /* Results */
        .result-area { margin-top: 40px; display: none; }
        .report-tools { display: flex; gap: 10px; margin-bottom: 20px; justify-content: space-between; flex-wrap: wrap; }
        .btn-tool { flex: 1; padding: 10px; font-size: 0.85rem; border-radius: 8px; cursor: pointer; font-weight: bold; border: 1px solid #cbd5e1; background: #fff; color: #475569; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .btn-tool:hover { background: #f1f5f9; color: var(--primary); }
        .shop-btn { background: var(--success); color: white; border: none; border-bottom: 3px solid #059669; }

        /* Timeline & Lanes */
        .timeline { border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden; margin-bottom: 30px; background: #fff; }
        .time-slot { display: flex; flex-direction: column; border-bottom: 1px solid #f1f5f9; }
        @media (min-width: 600px) { .time-slot { flex-direction: row; } }
        .time-label { width: 100%; background: #f8fafc; padding: 12px; font-size: 0.8rem; font-weight: bold; color: var(--primary); text-align: center; border-bottom: 1px solid #f1f5f9; }
        @media (min-width: 600px) { .time-label { width: 140px; border-bottom: none; border-right: 1px solid #f1f5f9; display: flex; align-items: center; justify-content: center; } }
        .time-content { flex: 1; padding: 10px; display: flex; flex-wrap: wrap; gap: 5px; }
        .supp-pill { padding: 3px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: bold; border: 1px solid; }
        .pill-take { background: var(--lane-a); color: #047857; border-color: #a7f3d0; }
        .pill-add { background: var(--lane-b); color: #c2410c; border-color: #fed7aa; }

        .lane-container { margin-bottom: 30px; }
        .lane-header { font-size: 1rem; font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .lane-badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; color: white; }
        .lane-a-badge { background: var(--success); }
        .lane-b-badge { background: #f97316; }
        .lane-c-badge { background: #94a3b8; }

        .detail-card { background: #fff; border: 1px solid #e2e8f0; padding: 15px; border-radius: 12px; margin-bottom: 15px; position: relative; }
        .card-lane-a { border-left: 5px solid var(--success); }
        .card-lane-b { border-left: 5px solid #f97316; }
        .card-lane-c { border-left: 5px solid #cbd5e1; background: #f8fafc; opacity: 0.9; }
        .detail-card.warning { border: 2px solid var(--danger); background: #fff5f5; }
        
        .card-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .supp-name { font-weight: bold; font-size: 1rem; }
        
        /* SCORE BADGE */
        .score-badge { 
            font-size: 0.9rem; font-weight: 800; padding: 4px 10px; border-radius: 8px; color: white; min-width: 50px; text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .score-high { background: linear-gradient(135deg, #ef4444, #f87171); } 
        .score-mid { background: linear-gradient(135deg, #3b82f6, #60a5fa); } 
        .score-low { background: #94a3b8; }

        .info-row { font-size: 0.85rem; margin-bottom: 4px; display: flex; gap: 10px; align-items: baseline; }
        .info-label { font-weight: bold; color: #64748b; font-size: 0.75rem; min-width: 60px; }
        .reason-row { font-size: 0.75rem; color: #64748b; margin-top: 5px; background: rgba(0,0,0,0.02); padding: 4px 8px; border-radius: 4px; }
        
        .pubmed-link { display: inline-block; color: var(--accent); text-decoration: none; font-weight: bold; padding: 4px 0; }
        .pubmed-link:hover { text-decoration: underline; }

        @media print {
            body { background: #fff; }
            .container { box-shadow: none; margin: 0; padding: 0; max-width: 100%; }
            .tos-summary, .grid-inputs, .pain-grid, .safety-grid, .tab-container, .advanced-settings, .btn-analyze, .disclaimer-box, .report-tools, .trainer-admin { display: none !important; }
            .result-area { display: block !important; margin-top: 0; }
            .detail-card { break-inside: avoid; border: 1px solid #ccc; }
        }
    </style>
</head>
<body>

<div class="container">
    <details class="tos-summary">
        <summary>ğŸ“œ åˆ©ç”¨è¦ç´„ã‚µãƒãƒªãƒ¼ (2026/02/13ç‰ˆ) - ORIVEX</summary>
        <div class="tos-content">
            <h4>ã€é‡è¦ã€‘éåŒ»ç™‚è¡Œç‚ºã®ç¢ºèª</h4>
            <ul>
                <li>æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã€ŒSUPPLEMENT-ORACLE-ã€ã¯åŒ»ç™‚æ©Ÿå™¨ã§ã¯ãªãã€ææ¡ˆå†…å®¹ã¯åŒ»å¸«ã®è¨ºæ–­ãƒ»å‡¦æ–¹ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>
                <li>ã‚µãƒ—ãƒªãƒ¡ãƒ³ãƒˆã®æ‘‚å–ã¯ã€åˆ©ç”¨è€…è‡ªèº«ã®è²¬ä»»ã¨åˆ¤æ–­ã«ãŠã„ã¦è¡Œã£ã¦ãã ã•ã„ã€‚</li>
            </ul>
            <h4>ç¦æ­¢äº‹é …</h4>
            <ul>
                <li>æœ¬ãƒ„ãƒ¼ãƒ«ã®è¤‡è£½ã€æ”¹å¤‰ã€ãƒªãƒãƒ¼ã‚¹ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ã€‚</li>
                <li>æœ¬ãƒ„ãƒ¼ãƒ«ã‚’ç”¨ã„ãŸç¬¬ä¸‰è€…ã¸ã®æœ‰æ–™è¨ºæ–­ã‚µãƒ¼ãƒ“ã‚¹ã®æä¾›ï¼ˆè¨±å¯ã•ã‚ŒãŸãƒ—ãƒ©ãƒ³ã‚’é™¤ãï¼‰ã€‚</li>
                <li>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®è­²æ¸¡ã‚„å…±æœ‰ã€‚</li>
            </ul>
            <h4>é‹å–¶ãƒ»é€£çµ¡å…ˆ</h4>
            <ul>
                <li>é‹å–¶ãƒ–ãƒ©ãƒ³ãƒ‰: ORIVEX</li>
                <li>åˆ¶å®šæ—¥: 2026å¹´2æœˆ13æ—¥</li>
            </ul>
            <div class="tos-contact">
                ãŠå•ã„åˆã‚ã›: muscleprime17@gmail.com
            </div>
        </div>
    </details>

    <div id="trainerAdmin" class="trainer-admin">
        <div class="admin-header" onclick="toggleAdmin()">ğŸ› ï¸ ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ç”¨è¨­å®šãƒ‘ãƒãƒ« (ã‚¯ãƒªãƒƒã‚¯ã§é–‹é–‰)</div>
        <div class="admin-controls" id="adminContent" style="display:none;">
            <p style="font-size:0.8rem; color:#64748b;">ä»¥ä¸‹ã‚’è¨­å®šã—ã¦ã€Œã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”¨URLã€ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚</p>
            <div><label>å±‹å·ãƒ»ã‚¸ãƒ å</label><input type="text" id="adminGymName" placeholder="ä¾‹: ã€‡ã€‡ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ã‚¸ãƒ "></div>
            <div><label>ç›£ä¿®ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼å</label><input type="text" id="adminTrainerName" placeholder="ä¾‹: å±±ç”° å¤ªéƒ"></div>
            <div><label>æ¨å¥¨ã‚·ãƒ§ãƒƒãƒ—URL</label><input type="url" id="adminShopUrl" placeholder="ä¾‹: https://jp.iherb.com/?rcode=..."></div>
            <button class="btn-copy" onclick="generateClientLink()">ğŸ”— ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆé…å¸ƒç”¨URLã‚’ã‚³ãƒ”ãƒ¼</button>
            <div id="generatedLink" style="font-size:0.8rem; word-break:break-all; color:#2563eb; margin-top:5px;"></div>
        </div>
    </div>

    <h1 id="appTitle">SUPPLEMENT ORACLE <span style="font-size:0.5em; vertical-align:top; background:var(--primary); color:white; padding:2px 6px; border-radius:4px;">v11.6</span></h1>
    <div class="subtitle" id="appSubtitle">Personalized Supplement Planner</div>
    <div id="supervisorArea" style="text-align:center;"></div>
    
    <div class="grid-inputs">
        <div><label>æ€§åˆ¥</label><select id="gender"><option value="male">ç”·æ€§</option><option value="female">å¥³æ€§</option></select></div>
        <div><label>ä½“é‡ (kg)</label><input type="number" id="weight" value="70" min="30" max="150"></div>
        <div><label>ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ­´</label><select id="history"><option value="beginner">1å¹´æœªæº€ (åˆç´š)</option><option value="intermediate" selected>1-3å¹´ (ä¸­ç´š)</option><option value="advanced">3å¹´ä»¥ä¸Š (ä¸Šç´š)</option></select></div>
        <div><label>ç›®çš„</label><select id="goal"><option value="maintenance">å¥åº·ç¶­æŒ</option><option value="bulking">å¢—é‡ãƒ»ç­‹è‚¥å¤§</option><option value="cutting">æ¸›é‡ãƒ»å¼•ãç· ã‚</option></select></div>
    </div>

    <div class="section-title">è§£æ±ºã—ãŸã„èª²é¡Œï¼ˆè¤‡æ•°é¸æŠï¼‰</div>
    <div class="pain-grid" id="painGrid">
        <label class="check-card"><input type="checkbox" name="pain" value="pump"> ãƒ‘ãƒ³ãƒ—ãƒ»è¡€ç®¡æ‹¡å¼µ</label>
        <label class="check-card"><input type="checkbox" name="pain" value="s_plateau"> ç­‹åŠ›ãƒ»é‡é‡åœæ»</label>
        <label class="check-card"><input type="checkbox" name="pain" value="fatigue"> æ…¢æ€§ç–²åŠ´ãƒ»å›å¾©</label>
        <label class="check-card"><input type="checkbox" name="pain" value="doms"> ç­‹è‚‰ç—›ãŒå–ã‚Œãªã„</label>
        <label class="check-card"><input type="checkbox" name="pain" value="stress"> ã‚¹ãƒˆãƒ¬ã‚¹ãƒ»é›†ä¸­åŠ›</label>
        <label class="check-card"><input type="checkbox" name="pain" value="sleep"> ç¡çœ ã®è³ªãƒ»å¯èµ·ã</label>
        <label class="check-card"><input type="checkbox" name="pain" value="w_plateau"> è„‚è‚ªç‡ƒç„¼ãƒ»ä»£è¬</label>
        <label class="check-card"><input type="checkbox" name="pain" value="stomach"> èƒƒè…¸ãƒ»æ¶ˆåŒ–å¸å</label>
        <label class="check-card"><input type="checkbox" name="pain" value="joint"> é–¢ç¯€ç—›ãƒ»æ€ªæˆ‘äºˆé˜²</label>
        <label class="check-card"><input type="checkbox" name="pain" value="hormone"> æ´»åŠ›ãƒ»ç”·æ€§æ©Ÿèƒ½</label>
        <label class="check-card"><input type="checkbox" name="pain" value="skin"> è‚Œè’ã‚Œãƒ»æŠ—é…¸åŒ–</label>
        <label class="check-card" style="border:1px solid #bae6fd;"><input type="checkbox" name="pain" value="anemia"> è²§è¡€ãƒ»å†·ãˆæ€§</label>
    </div>

    <div class="advanced-settings">
        <div class="advanced-summary" onclick="document.getElementById('advContent').classList.toggle('show')">
            <span>âš™ï¸ è¡¨ç¤ºè¨­å®š (ä»¶æ•°ãƒ»é–¾å€¤)</span><span>â–¼</span>
        </div>
        <div class="advanced-content" id="advContent">
            <div><label>æœ€å¤§è¡¨ç¤ºä»¶æ•° (Lane B)</label><select id="maxDisplay"><option value="7">æ¨™æº– (7ä»¶)</option><option value="10">å¤šã‚ (10ä»¶)</option><option value="99">å…¨ä»¶è¡¨ç¤º</option></select></div>
            <div><label>ææ¡ˆã®å³æ ¼ã•</label><select id="scoreThreshold"><option value="10">æ¨™æº–</option><option value="0">ç·©å’Œ (å…¨ã¦è¡¨ç¤º)</option><option value="25">å³æ ¼</option></select></div>
        </div>
    </div>

    <div class="section-title">ç¾åœ¨æ‘‚å–ä¸­ã®ã‚µãƒ—ãƒª (Stack)</div>
    <div class="tab-container">
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('base')">åŸºæœ¬ãƒ»å¥åº·</button>
            <button class="tab-btn" onclick="switchTab('perf')">ç­‹åŠ›ãƒ»ãƒˆãƒ¬</button>
            <button class="tab-btn" onclick="switchTab('diet')">ç‡ƒç„¼ãƒ»ä»£è¬</button>
            <button class="tab-btn" onclick="switchTab('brain')">è„³ãƒ»ç¡çœ </button>
            <button class="tab-btn" onclick="switchTab('care')">ã‚±ã‚¢ãƒ»èª¿æ•´</button>
        </div>
        <div id="tab-base" class="tab-content active taken-grid"></div>
        <div id="tab-perf" class="tab-content taken-grid"></div>
        <div id="tab-diet" class="tab-content taken-grid"></div>
        <div id="tab-brain" class="tab-content taken-grid"></div>
        <div id="tab-care" class="tab-content taken-grid"></div>
    </div>

    <div class="section-title">å®‰å…¨æ€§ãƒ»ä½“è³ªãƒã‚§ãƒƒã‚¯</div>
    <div class="safety-grid">
        <label class="check-card"><input type="checkbox" name="safety" value="hi_bp"> é«˜è¡€åœ§æ°—å‘³</label>
        <label class="check-card"><input type="checkbox" name="safety" value="insomnia"> ä¸çœ å‚¾å‘</label>
        <label class="check-card"><input type="checkbox" name="safety" value="kidney"> è…æ©Ÿèƒ½ä¸å®‰</label>
        <label class="check-card"><input type="checkbox" name="safety" value="thyroid"> ç”²çŠ¶è…ºç–¾æ‚£</label>
        <label class="check-card"><input type="checkbox" name="safety" value="meds"> å‡¦æ–¹è–¬ã‚’æœç”¨ä¸­</label>
        <label class="check-card"><input type="checkbox" name="safety" value="pill"> ä½ç”¨é‡ãƒ”ãƒ«æœç”¨</label>
    </div>

    <div class="disclaimer-box">
        <div><b>ã€å…è²¬äº‹é …ã€‘</b> æœ¬ãƒ„ãƒ¼ãƒ«ã¯ä¸€èˆ¬çš„ãªæƒ…å ±æä¾›ã®ã¿ã‚’ç›®çš„ã¨ã—ã¦ãŠã‚Šã€åŒ»ç™‚ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æ‘‚å–ã¯è‡ªå·±è²¬ä»»ã§è¡Œã£ã¦ãã ã•ã„ã€‚</div>
        <label style="display:flex; gap:10px; margin-top:10px; align-items:center; cursor:pointer;">
            <input type="checkbox" id="agreeCheck"> ä¸Šè¨˜ã«åŒæ„ã—ã¦åˆ©ç”¨ã™ã‚‹
        </label>
    </div>

    <button class="btn-analyze" id="btnAnalyze" disabled>ã‚¹ã‚¿ãƒƒã‚¯æœ€é©åŒ– & ææ¡ˆç”Ÿæˆ</button>

    <div id="resultArea" class="result-area">
        <div class="report-tools">
            <button class="btn-tool" onclick="copyReport()">ğŸ“‹ ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚³ãƒ”ãƒ¼<br><span style="font-size:0.7em">(ã‚¹ãƒãƒ›æ¨å¥¨)</span></button>
            <button class="btn-tool" onclick="window.print()">ğŸ–¨ï¸ å°åˆ· / PDFä¿å­˜<br><span style="font-size:0.7em">(PC/å¤–éƒ¨ãƒ–ãƒ©ã‚¦ã‚¶ç”¨)</span></button>
        </div>
        <button id="shopBtn" class="btn-tool shop-btn" style="display:none; width:100%; margin-bottom:20px;" onclick="openShop()">ğŸ›’ æ¨å¥¨ã‚·ãƒ§ãƒƒãƒ—ã¸è¡Œã</button>

        <div class="section-title">æ¨å¥¨æ‘‚å–ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</div>
        <div id="timeline" class="timeline"></div>
        
        <div class="lane-container" id="laneAContainer">
            <div class="lane-header"><span class="lane-badge lane-a-badge">Lane A</span> ç¾åœ¨ã®ã‚¹ã‚¿ãƒƒã‚¯ (ç¶™ç¶š/èª¿æ•´)</div>
            <div id="laneAContent"></div>
        </div>
        
        <div class="lane-container" id="laneBContainer">
            <div class="lane-header"><span class="lane-badge lane-b-badge">Lane B</span> è¿½åŠ æ¨å¥¨ã‚µãƒ—ãƒªãƒ¡ãƒ³ãƒˆ (Priority)</div>
            <div id="laneBContent"></div>
        </div>

        <div class="lane-container" id="laneCContainer">
            <div class="lane-header"><span class="lane-badge lane-c-badge">Lane C</span> ææ¡ˆé™¤å¤–ãƒ»è¦‹é€ã‚Š (å‚è€ƒ/Top 3)</div>
            <div id="laneCContent"></div>
        </div>
    </div>
</div>

<script>
    /* --- CONFIG & TRANSLATIONS --- */
    const safetyLabels = { hi_bp: "é«˜è¡€åœ§", insomnia: "ä¸çœ ", kidney: "è…æ©Ÿèƒ½", thyroid: "ç”²çŠ¶è…º", meds: "æœè–¬ä¸­", pill: "ãƒ”ãƒ«æœç”¨" };
    const triggerLabels = {
        pump: "ãƒ‘ãƒ³ãƒ—æ„Ÿ", s_plateau: "ç­‹åŠ›åœæ»", fatigue: "ç–²åŠ´å›å¾©", doms: "ç­‹è‚‰ç—›",
        stress: "ã‚¹ãƒˆãƒ¬ã‚¹", sleep: "ç¡çœ ", w_plateau: "è„‚è‚ªç‡ƒç„¼", stomach: "èƒƒè…¸",
        joint: "é–¢ç¯€", hormone: "æ´»åŠ›", skin: "è‚Œãƒ»æŠ—é…¸åŒ–", anemia: "è²§è¡€ãƒ»å†·ãˆ"
    };
    let trainerShopUrl = "";
    let supervisorName = "";

    /* --- DB (54 Items) --- */
    const DB = [
        // Tab 1: Base
        { id: 'multivitamin', cat:'base', name: 'ãƒãƒ«ãƒãƒ“ã‚¿ãƒŸãƒ³', level:1, triggers:['fatigue','skin'], goalBonus:['maintenance'], timing:'morning', priority:6, dose:w=>`è¦å®šé‡`, pro:'å¾®é‡æ „é¤Šç´ ã®åº•ä¸Šã’', pmid:'22987599' },
        { id: 'vit_b', cat:'base', name: 'ãƒ“ã‚¿ãƒŸãƒ³Bç¾¤', level:1, triggers:['fatigue','w_plateau','anemia'], goalBonus:['cutting'], timing:'morning', priority:8, dose:w=>`è¦å®šé‡`, pro:'ç³–è³ªãƒ»è„‚è³ªã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ä»£è¬', pmid:'31963141' },
        { id: 'vit_d', cat:'base', name: 'ãƒ“ã‚¿ãƒŸãƒ³D3', level:1, triggers:['hormone','stress','joint'], goalBonus:['maintenance'], timing:'morning', priority:9, dose:w=>`2000-5000IU`, caution:'è„‚æº¶æ€§', pro:'å…ç–«ã€éª¨ã€ãƒ¡ãƒ³ã‚¿ãƒ«', pmid:'21154195' },
        { id: 'vit_c', cat:'base', name: 'ãƒ“ã‚¿ãƒŸãƒ³C', level:1, triggers:['skin','stress','fatigue','anemia'], goalBonus:['maintenance','cutting'], timing:'anytime', priority:8, dose:w=>`1000-2000mg`, pro:'æŠ—é…¸åŒ–ã€é‰„åˆ†å¸åè£œåŠ©', pmid:'23927692' },
        { id: 'vit_e', cat:'base', name: 'ãƒ“ã‚¿ãƒŸãƒ³E', level:2, triggers:['skin','hormone','anemia'], goalBonus:['maintenance'], timing:'with_meal', priority:6, dose:w=>`400IU`, caution:'è„‚æº¶æ€§', pro:'è¡€æµæ”¹å–„ã€æŠ—é…¸åŒ–', pmid:'27559512' },
        { id: 'vit_k2', cat:'base', name: 'ãƒ“ã‚¿ãƒŸãƒ³K2', level:2, triggers:['joint','hormone'], goalBonus:['maintenance'], timing:'with_meal', priority:6, dose:w=>`100mcg`, pro:'ã‚«ãƒ«ã‚·ã‚¦ãƒ å®šç€ã€éª¨å¯†åº¦', pmid:'23594657' },
        { id: 'zinc', cat:'base', name: 'äºœé‰›', level:1, triggers:['hormone','fatigue','skin'], goalBonus:['bulking'], timing:'before_sleep', priority:8, dose:w=>`15-30mg`, caution:'ç©ºè…¹æ™‚åãæ°—', pro:'ç´°èƒåˆ†è£‚ã€ãƒ›ãƒ«ãƒ¢ãƒ³åˆæˆ', pmid:'8875519' },
        { id: 'omega3', cat:'base', name: 'ã‚ªãƒ¡ã‚¬3 (EPA/DHA)', level:1, triggers:['joint','stress','skin'], goalBonus:['maintenance','cutting'], timing:'with_meal', priority:9, dose:w=>`2000-3000mg`, contra:'meds', pro:'æŠ—ç‚ç—‡ã€è¡€ç®¡ä¿è­·', pmid:'21784145' },
        { id: 'probiotics', cat:'base', name: 'ãƒ—ãƒ­ãƒã‚¤ã‚ªãƒ†ã‚£ã‚¯ã‚¹', level:1, triggers:['stomach'], goalBonus:['maintenance'], timing:'morning', priority:6, dose:w=>`1-2ã‚«ãƒ—ã‚»ãƒ«`, pro:'è…¸å†…ç’°å¢ƒã€æ¶ˆåŒ–å¸å', pmid:'24912204' },
        { id: 'digestive_enzymes', cat:'base', name: 'æ¶ˆåŒ–é…µç´ ', level:1, triggers:['stomach'], goalBonus:['bulking'], timing:'with_meal', priority:5, dose:w=>`è¦å®šé‡`, pro:'æ „é¤Šåˆ†è§£ã®è£œåŠ©', pmid:'29878239' },
        { id: 'iron', cat:'base', name: 'é‰„åˆ† (ãƒ˜ãƒ é‰„)', level:1, triggers:['fatigue','anemia'], goalBonus:['maintenance'], timing:'with_meal', priority:6, dose:w=>`10-20mg`, genderOnly:'female', pro:'é…¸ç´ é‹æ¬ã€è²§è¡€äºˆé˜²', pmid:'24914241' },
        { id: 'nac', cat:'base', name: 'NAC (N-ã‚¢ã‚»ãƒãƒ«ã‚·ã‚¹ãƒ†ã‚¤ãƒ³)', level:2, triggers:['fatigue','skin'], goalBonus:['maintenance'], timing:'with_meal', priority:5, dose:w=>`600-1200mg`, pro:'è‚è‡“ã‚±ã‚¢ã€ã‚°ãƒ«ã‚¿ãƒã‚ªãƒ³å‰é§†ä½“', pmid:'29742538' },
        { id: 'coq10', cat:'base', name: 'ã‚³ã‚¨ãƒ³ã‚¶ã‚¤ãƒ Q10 (é‚„å…ƒå‹)', level:2, triggers:['fatigue','skin'], goalBonus:['maintenance'], timing:'with_meal', priority:6, dose:w=>`100mg`, caution:'è„‚æº¶æ€§', pro:'ãƒŸãƒˆã‚³ãƒ³ãƒ‰ãƒªã‚¢æ´»æ€§åŒ–', pmid:'20691130' },

        // Tab 2: Perf
        { id: 'creatine', cat:'perf', name: 'ã‚¯ãƒ¬ã‚¢ãƒãƒ³', level:1, triggers:['s_plateau','pump'], goalBonus:['bulking'], timing:'post_workout', priority:10, dose:w=>`${Math.round(w*0.05)}g`, contra:'kidney', pro:'ç¬ç™ºåŠ›ã€æ°´åˆ†ä¿æŒ', pmid:'28615996' },
        { id: 'eaa', cat:'perf', name: 'EAA (å¿…é ˆã‚¢ãƒŸãƒé…¸)', level:2, triggers:['fatigue','doms'], goalBonus:['bulking','cutting'], timing:'intra_workout', priority:7, dose:w=>`10-15g`, pro:'ç­‹åˆ†è§£æŠ‘åˆ¶ã€åˆæˆä¿ƒé€²', pmid:'28919842' },
        { id: 'hmb', cat:'perf', name: 'HMB', level:2, triggers:['doms','fatigue'], goalBonus:['cutting'], timing:'pre_workout', priority:1, dose:w=>`3000mg`, caution:'åˆå¿ƒè€…ã«æœ‰åŠ¹', pro:'æŠ—ã‚«ã‚¿ãƒœãƒªãƒƒã‚¯', pmid:'23241341' },
        { id: 'beta_alanine', cat:'perf', name: 'ãƒ™ãƒ¼ã‚¿ã‚¢ãƒ©ãƒ‹ãƒ³', level:2, triggers:['fatigue','s_plateau'], goalBonus:['bulking'], timing:'pre_workout', priority:7, dose:w=>`3.2g`, caution:'ãƒ”ãƒªãƒ”ãƒªæ„Ÿ', pro:'æŒä¹…åŠ›ã€ä¹³é…¸ç·©è¡', pmid:'22270875' },
        { id: 'citrulline', cat:'perf', name: 'L-ã‚·ãƒˆãƒ«ãƒªãƒ³', level:1, triggers:['pump','doms','fatigue','anemia'], goalBonus:['bulking'], timing:'pre_workout', priority:9, dose:w=>`6000-8000mg`, caution:'ä½è¡€åœ§æ³¨æ„', pro:'è¡€ç®¡æ‹¡å¼µã€ãƒ‘ãƒ³ãƒ—', pmid:'20386132' },
        { id: 'sodium', cat:'perf', name: 'ãƒŠãƒˆãƒªã‚¦ãƒ  (å¡©åˆ†)', level:1, triggers:['pump','fatigue'], goalBonus:['bulking'], timing:'intra_workout', priority:8, dose:w=>`1000-2000mg`, contra:'hi_bp', pro:'è¡€æµé‡ç¶­æŒã€æ”£ã‚Šé˜²æ­¢', pmid:'25916908' },
        { id: 'beetroot', cat:'perf', name: 'ãƒ“ãƒ¼ãƒˆãƒ«ãƒ¼ãƒˆ (ç¡é…¸å¡©)', level:2, triggers:['pump','fatigue','anemia'], goalBonus:['cutting'], timing:'pre_workout', priority:6, dose:w=>`300-500mg(NO3)`, pro:'æœ‰é…¸ç´ æŒä¹…åŠ›ã€NOç”£ç”Ÿ', pmid:'23640589' },
        { id: 'maltodextrin', cat:'perf', name: 'ãƒãƒ«ãƒˆãƒ‡ã‚­ã‚¹ãƒˆãƒªãƒ³ (ç²‰é£´)', level:1, triggers:['fatigue','s_plateau'], goalBonus:['bulking'], timing:'intra_workout', priority:7, dose:w=>`ä½“é‡Ã—0.5-1.0g`, pro:'å³åŠ¹æ€§ã‚¨ãƒãƒ«ã‚®ãƒ¼æº', pmid:'11591881' },
        { id: 'betaine', cat:'perf', name: 'ãƒ™ã‚¿ã‚¤ãƒ³ (TMG)', level:2, triggers:['s_plateau','pump'], goalBonus:['bulking'], timing:'pre_workout', priority:5, dose:w=>`2500mg`, pro:'ãƒ‘ãƒ¯ãƒ¼å‡ºåŠ›ã€æ°´åˆ†ä¿æŒ', pmid:'23967897' },
        { id: 'taurine', cat:'perf', name: 'ã‚¿ã‚¦ãƒªãƒ³', level:2, triggers:['fatigue','pump'], goalBonus:['cutting'], timing:'pre_workout', priority:6, dose:w=>`1000-3000mg`, pro:'å¿ƒæ©Ÿèƒ½ã€ã‚¤ãƒ³ã‚¹ãƒªãƒ³æ„Ÿå—æ€§', pmid:'24615238' },
        { id: 'potassium', cat:'perf', name: 'ã‚«ãƒªã‚¦ãƒ ', level:2, triggers:['pump','doms'], goalBonus:['bulking'], timing:'with_meal', priority:6, dose:w=>`é£Ÿäº‹ã§ä¸è¶³åˆ†`, caution:'è…æ©Ÿèƒ½æ³¨æ„', contra:'kidney', pro:'ç­‹åç¸®ã€ã‚€ãã¿é˜²æ­¢', pmid:'23107525' },
        { id: 'glutamine', cat:'perf', name: 'L-ã‚°ãƒ«ã‚¿ãƒŸãƒ³', level:1, triggers:['stomach','doms'], goalBonus:['bulking'], timing:'post_workout', priority:7, dose:w=>`5g`, pro:'å…ç–«ç¶­æŒã€ã‚°ãƒªã‚³ãƒ¼ã‚²ãƒ³å›å¾©', pmid:'29462271' },

        // Tab 3: Diet
        { id: 'caffeine', cat:'diet', name: 'ã‚«ãƒ•ã‚§ã‚¤ãƒ³', level:1, triggers:['w_plateau','fatigue'], goalBonus:['cutting'], timing:'pre_workout', priority:7, dose:w=>`${Math.round(w*3)}-${Math.round(w*5)}mg`, contra:'insomnia', pro:'è„‚è‚ªç‡ƒç„¼ã€è¦šé†’', pmid:'2912010' },
        { id: 'carnitine', cat:'diet', name: 'L-ã‚«ãƒ«ãƒ‹ãƒãƒ³', level:2, triggers:['w_plateau'], goalBonus:['cutting'], timing:'pre_workout', priority:6, dose:w=>`2000mg`, pro:'è„‚è‚ªé…¸è¼¸é€ã€ãƒŸãƒˆã‚³ãƒ³ãƒ‰ãƒªã‚¢', pmid:'29381391' },
        { id: 'berberine', cat:'diet', name: 'ãƒ™ãƒ«ãƒ™ãƒªãƒ³', level:3, triggers:['w_plateau'], goalBonus:['cutting'], timing:'pre_meal', priority:6, dose:w=>`500mg`, contra:'meds', pro:'ç³–åˆ©ç”¨ä¿ƒé€²(GDA)', pmid:'18442638' },
        { id: 'cla', cat:'diet', name: 'CLA (å…±å½¹ãƒªãƒãƒ¼ãƒ«é…¸)', level:2, triggers:['w_plateau'], goalBonus:['cutting'], timing:'with_meal', priority:4, dose:w=>`3000mg`, pro:'è„‚è‚ªåˆ†è§£é…µç´ æ´»æ€§åŒ–', pmid:'17490954' },
        { id: 'fiber', cat:'diet', name: 'é£Ÿç‰©ç¹Šç¶­ (ã‚µã‚¤ãƒªã‚¦ãƒ ç­‰)', level:1, triggers:['stomach','w_plateau'], goalBonus:['cutting'], timing:'with_meal', priority:6, dose:w=>`5-10g`, pro:'è¡€ç³–å€¤æŠ‘åˆ¶ã€æº€è…¹æ„Ÿ', pmid:'28612143' },
        { id: 'egcg', cat:'diet', name: 'EGCG (ç·‘èŒ¶ã‚«ãƒ†ã‚­ãƒ³)', level:2, triggers:['w_plateau'], goalBonus:['cutting'], timing:'pre_workout', priority:5, dose:w=>`400-800mg`, pro:'ä»£è¬å‘ä¸Šã€è„‚è‚ªé…¸åŒ–', pmid:'21115335' },
        { id: 'chromium', cat:'diet', name: 'ã‚¯ãƒ­ãƒ ', level:2, triggers:['w_plateau'], goalBonus:['cutting'], timing:'with_meal', priority:5, dose:w=>`200-400mcg`, pro:'ã‚¤ãƒ³ã‚¹ãƒªãƒ³æ„Ÿå—æ€§ã€é£Ÿæ¬²æŠ‘åˆ¶', pmid:'15208835' },
        { id: 'mct', cat:'diet', name: 'MCTã‚ªã‚¤ãƒ«', level:2, triggers:['w_plateau','fatigue'], goalBonus:['cutting'], timing:'morning', priority:5, dose:w=>`5-15ml`, caution:'ç©ºè…¹æ™‚ã¯è…¹ç—›æ³¨æ„', pro:'ã‚±ãƒˆãƒ³ä½“ç”Ÿæˆã€å³åŠ¹æ€§ç‡ƒæ–™', pmid:'11880549' },
        { id: 'ala', cat:'diet', name: 'ã‚¢ãƒ«ãƒ•ã‚¡ãƒªãƒé…¸ (ALA)', level:2, triggers:['w_plateau','skin'], goalBonus:['cutting'], timing:'with_meal', priority:5, dose:w=>`300-600mg`, pro:'ç³–ä»£è¬ã€å¼·åŠ›ãªæŠ—é…¸åŒ–', pmid:'21666939' },
        { id: 'inulin', cat:'diet', name: 'ã‚¤ãƒŒãƒªãƒ³ (æ°´æº¶æ€§é£Ÿç‰©ç¹Šç¶­)', level:1, triggers:['stomach'], goalBonus:['maintenance'], timing:'with_meal', priority:5, dose:w=>`5-10g`, pro:'ãƒ—ãƒ¬ãƒã‚¤ã‚ªãƒ†ã‚£ã‚¯ã‚¹', pmid:'27178951' },

        // Tab 4: Brain
        { id: 'magnesium', cat:'brain', name: 'ãƒã‚°ãƒã‚·ã‚¦ãƒ ', level:1, triggers:['sleep','stress','doms'], goalBonus:['maintenance'], timing:'before_sleep', priority:9, dose:w=>`200-400mg`, contra:'kidney', pro:'ãƒªãƒ©ãƒƒã‚¯ã‚¹ã€æ·±ç¡çœ ', pmid:'23853635' },
        { id: 'ashwagandha', cat:'brain', name: 'ã‚¢ã‚·ãƒ¥ãƒ¯ã‚¬ãƒ³ãƒ€', level:3, triggers:['stress','hormone','sleep'], goalBonus:['bulking'], timing:'dinner', priority:7, dose:w=>`300-600mg`, contra:'thyroid', pro:'ã‚³ãƒ«ãƒã‚¾ãƒ¼ãƒ«æŠ‘åˆ¶', pmid:'23439798' },
        { id: 'theanine', cat:'brain', name: 'L-ãƒ†ã‚¢ãƒ‹ãƒ³', level:1, triggers:['stress','fatigue'], goalBonus:['maintenance'], timing:'pre_workout', priority:6, dose:w=>`200mg`, pro:'ãƒªãƒ©ãƒƒã‚¯ã‚¹é›†ä¸­ã€ã‚«ãƒ•ã‚§ã‚¤ãƒ³ä¸­å’Œ', pmid:'18681988' },
        { id: 'tyrosine', cat:'brain', name: 'L-ãƒãƒ­ã‚·ãƒ³', level:2, triggers:['stress','fatigue'], goalBonus:['cutting'], timing:'pre_workout', priority:5, dose:w=>`1000-2000mg`, contra:'thyroid', pro:'ãƒ‰ãƒ¼ãƒ‘ãƒŸãƒ³åŸæ–™ã€ã‚¹ãƒˆãƒ¬ã‚¹è€æ€§', pmid:'26424423' },
        { id: 'glycine', cat:'brain', name: 'ã‚°ãƒªã‚·ãƒ³', level:2, triggers:['sleep','skin'], goalBonus:['maintenance'], timing:'before_sleep', priority:6, dose:w=>`3000mg`, pro:'æ·±éƒ¨ä½“æ¸©ä½ä¸‹ã€å…¥çœ ', pmid:'22293292' },
        { id: 'melatonin', cat:'brain', name: 'ãƒ¡ãƒ©ãƒˆãƒ‹ãƒ³ (â€»ãƒ›ãƒ«ãƒ¢ãƒ³)', level:2, triggers:['sleep'], goalBonus:['maintenance'], timing:'before_sleep', priority:5, dose:w=>`1-3mg`, caution:'å°‘é‡ã‹ã‚‰é–‹å§‹', pro:'å…¥çœ æ½œæ™‚çŸ­ç¸®', pmid:'24558197' },
        { id: 'rhodiola', cat:'brain', name: 'ãƒ­ãƒ‡ã‚£ã‚ªãƒ©', level:2, triggers:['stress','fatigue'], goalBonus:['maintenance'], timing:'morning', priority:5, dose:w=>`200-400mg`, pro:'æŠ—ç–²åŠ´ã€ç²¾ç¥å®‰å®š', pmid:'22228617' },
        { id: 'ps', cat:'brain', name: 'ãƒ›ã‚¹ãƒ•ã‚¡ãƒã‚¸ãƒ«ã‚»ãƒªãƒ³', level:2, triggers:['stress','fatigue'], goalBonus:['cutting'], timing:'dinner', priority:6, dose:w=>`400-800mg`, pro:'ã‚³ãƒ«ãƒã‚¾ãƒ¼ãƒ«æŠ‘åˆ¶ã€è„³æ©Ÿèƒ½', pmid:'18616866' },
        { id: 'gaba', cat:'brain', name: 'GABA', level:1, triggers:['sleep','stress'], goalBonus:['maintenance'], timing:'before_sleep', priority:6, dose:w=>`100-200mg`, pro:'å‰¯äº¤æ„Ÿç¥çµŒå„ªä½ã€ãƒªãƒ©ãƒƒã‚¯ã‚¹', pmid:'33066354' },
        { id: 'alpha_gpc', cat:'brain', name: 'ã‚¢ãƒ«ãƒ•ã‚¡GPC', level:3, triggers:['s_plateau','stress'], goalBonus:['bulking'], timing:'pre_workout', priority:5, dose:w=>`300-600mg`, pro:'æˆé•·ãƒ›ãƒ«ãƒ¢ãƒ³ã€ç¬ç™ºåŠ›', pmid:'22673596' },
        { id: 'tryptophan', cat:'brain', name: 'ãƒˆãƒªãƒ—ãƒˆãƒ•ã‚¡ãƒ³', level:2, triggers:['sleep','stress'], goalBonus:['maintenance'], timing:'before_sleep', priority:5, dose:w=>`500-1000mg`, contra:'meds', pro:'ã‚»ãƒ­ãƒˆãƒ‹ãƒ³ãƒ»ãƒ¡ãƒ©ãƒˆãƒ‹ãƒ³ææ–™', pmid:'20529608' },
        { id: '5htp', cat:'brain', name: '5-HTP', level:3, triggers:['sleep','stress'], goalBonus:['cutting'], timing:'before_sleep', priority:5, dose:w=>`100-200mg`, contra:'meds', caution:'æŠ—ã†ã¤è–¬ä½µç”¨å³ç¦', pro:'ã‚»ãƒ­ãƒˆãƒ‹ãƒ³ç›´æ¥ç”Ÿæˆ', pmid:'9727088' },

        // Tab 5: Care
        { id: 'glucosamine', cat:'care', name: 'ã‚°ãƒ«ã‚³ã‚µãƒŸãƒ³', level:1, triggers:['joint'], goalBonus:['maintenance'], timing:'with_meal', priority:6, dose:w=>`1500mg`, caution:'ç”²æ®»é¡ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼', pro:'é–¢ç¯€è»Ÿéª¨ä¿è­·', pmid:'16461376' },
        { id: 'collagen', cat:'care', name: 'ã‚³ãƒ©ãƒ¼ã‚²ãƒ³', level:1, triggers:['joint','skin'], goalBonus:['maintenance'], timing:'anytime', priority:6, dose:w=>`5-10g`, pro:'çµåˆçµ„ç¹”ä¿®å¾©ã€è‚Œå¼¾åŠ›', pmid:'18416885' },
        { id: 'curcumin', cat:'care', name: 'ã‚¯ãƒ«ã‚¯ãƒŸãƒ³ (ã‚¦ã‚³ãƒ³)', level:2, triggers:['joint','fatigue'], goalBonus:['maintenance'], timing:'with_meal', priority:6, dose:w=>`500mg`, pro:'å¼·åŠ›ãªæŠ—ç‚ç—‡ã€è‚è‡“ã‚±ã‚¢', pmid:'23116312' },
        { id: 'astaxanthin', cat:'care', name: 'ã‚¢ã‚¹ã‚¿ã‚­ã‚µãƒ³ãƒãƒ³', level:2, triggers:['skin','fatigue'], goalBonus:['maintenance'], timing:'with_meal', priority:5, dose:w=>`4-12mg`, pro:'çœ¼ç²¾ç–²åŠ´ã€æŠ—é…¸åŒ–', pmid:'22628205' },
        { id: 'saw_palmetto', cat:'care', name: 'ãƒã‚³ã‚®ãƒªãƒ¤ã‚·', level:2, triggers:['hormone'], goalBonus:['maintenance'], timing:'with_meal', priority:4, dose:w=>`320mg`, genderOnly:'male', pro:'å‰ç«‹è…ºã‚±ã‚¢ã€DHTæŠ‘åˆ¶', pmid:'23253636' },
        { id: 'soy_iso', cat:'care', name: 'å¤§è±†ã‚¤ã‚½ãƒ•ãƒ©ãƒœãƒ³', level:2, triggers:['hormone','skin'], goalBonus:['maintenance'], timing:'with_meal', priority:4, dose:w=>`40-75mg`, genderOnly:'female', caution:'ãƒ”ãƒ«æœç”¨æ™‚ã¯æ³¨æ„', pro:'å¥³æ€§ãƒ›ãƒ«ãƒ¢ãƒ³æ§˜ä½œç”¨', pmid:'12163983' },
        { id: 'boron', cat:'care', name: 'ãƒ›ã‚¦ç´  (Boron)', level:3, triggers:['hormone'], goalBonus:['bulking'], timing:'with_meal', priority:5, dose:w=>`3-10mg`, caution:'ãƒ”ãƒ«æœç”¨æ™‚ã¯æ³¨æ„', pro:'éŠé›¢ãƒ†ã‚¹ãƒˆã‚¹ãƒ†ãƒ­ãƒ³å¢—åŠ ', pmid:'21129261' },
        { id: 'maca', cat:'care', name: 'ãƒã‚«', level:1, triggers:['hormone','fatigue'], goalBonus:['maintenance'], timing:'morning', priority:5, dose:w=>`1500-3000mg`, caution:'ãƒ›ãƒ«ãƒ¢ãƒ³ä½œç”¨ã«æ³¨æ„', pro:'æ»‹é¤Šå¼·å£®', pmid:'19781622' }
    ];

    document.addEventListener('DOMContentLoaded', () => {
        // Init Tabs
        DB.forEach(s => {
            const c = document.getElementById(`tab-${s.cat}`);
            if(c) c.innerHTML += `<label class="check-card taken-card"><input type="checkbox" name="taken" value="${s.id}"> ${s.name}</label>`;
        });
        loadSettings();
        document.getElementById('agreeCheck').addEventListener('change', function() {
            document.getElementById('btnAnalyze').disabled = !this.checked;
        });
        document.getElementById('btnAnalyze').addEventListener('click', analyze);
    });

    function switchTab(cat) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById(`tab-${cat}`).classList.add('active');
    }

    function loadSettings() {
        const saved = JSON.parse(localStorage.getItem('suppOracle_user') || '{}');
        if(saved.weight) document.getElementById('weight').value = saved.weight;
        if(saved.gender) document.getElementById('gender').value = saved.gender;
        if(saved.history) document.getElementById('history').value = saved.history;
        if(saved.goal) document.getElementById('goal').value = saved.goal;

        const params = new URLSearchParams(window.location.search);
        const gym = params.get('gym');
        const trainer = params.get('trainer');
        const shop = params.get('shop');
        if(gym) {
            document.getElementById('appTitle').innerHTML = decodeURIComponent(gym);
            document.getElementById('appSubtitle').innerText = "Personalized Supplement Planner";
        } else {
            document.getElementById('trainerAdmin').classList.add('show');
        }
        if(trainer) {
            supervisorName = decodeURIComponent(trainer);
            document.getElementById('supervisorArea').innerHTML = `<div class="supervisor">ç›£ä¿®: ${supervisorName} ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼</div>`;
        }
        if(shop) {
            trainerShopUrl = decodeURIComponent(shop);
            document.getElementById('shopBtn').style.display = 'block';
        }
    }

    function toggleAdmin() {
        const c = document.getElementById('adminContent');
        c.style.display = c.style.display === 'none' ? 'grid' : 'none';
    }

    function generateClientLink() {
        const gym = document.getElementById('adminGymName').value.trim();
        const trainer = document.getElementById('adminTrainerName').value.trim();
        const shop = document.getElementById('adminShopUrl').value.trim();
        let url = window.location.href.split('?')[0];
        const params = [];
        if(gym) params.push(`gym=${encodeURIComponent(gym)}`);
        if(trainer) params.push(`trainer=${encodeURIComponent(trainer)}`);
        if(shop) params.push(`shop=${encodeURIComponent(shop)}`);
        if(params.length > 0) url += `?${params.join('&')}`;
        document.getElementById('generatedLink').innerText = url;
        navigator.clipboard.writeText(url).then(() => alert('URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼'));
    }

    function analyze() {
        const w = document.getElementById('weight').value;
        localStorage.setItem('suppOracle_user', JSON.stringify({
            weight: w,
            gender: document.getElementById('gender').value,
            history: document.getElementById('history').value,
            goal: document.getElementById('goal').value
        }));

        const weight = parseFloat(w) || 70;
        const gender = document.getElementById('gender').value;
        const history = document.getElementById('history').value;
        const goal = document.getElementById('goal').value;
        const pains = Array.from(document.querySelectorAll('input[name="pain"]:checked')).map(c => c.value);
        const takens = Array.from(document.querySelectorAll('input[name="taken"]:checked')).map(c => c.value);
        const safeties = Array.from(document.querySelectorAll('input[name="safety"]:checked')).map(c => c.value);
        const maxDisplay = parseInt(document.getElementById('maxDisplay').value);
        const threshold = parseInt(document.getElementById('scoreThreshold').value);

        if(pains.length === 0 && takens.length === 0) {
            alert("æ‚©ã¿ã€ã¾ãŸã¯æ‘‚å–ä¸­ã®ã‚µãƒ—ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return;
        }

        let results = DB.map(s => {
            if (s.genderOnly && s.genderOnly !== gender) return null;
            let score = 0;
            let matchLogs = [];
            let warnings = [];

            // Trigger Match
            s.triggers.forEach(t => {
                if(pains.includes(t)) {
                    let pts = 20;
                    if(t === 'pump') pts = 40; 
                    if(t === 'anemia') pts = 30; // Anemia boost
                    if(t === 'w_plateau' && s.id === 'carnitine') pts = 35;
                    score += pts; 
                    matchLogs.push(triggerLabels[t] || t);
                }
            });

            // Bonus
            if(s.goalBonus && s.goalBonus.includes(goal)) {
                score += 15; matchLogs.push(`ç›®çš„ä¸€è‡´`);
            }

            // Level & HMB Logic
            const level = s.level || 1;
            score += (s.priority * 3);
            if(s.id === 'hmb') {
                if(history === 'beginner' && goal === 'cutting') score += 5; 
                else score -= 20; 
            } else {
                if(history === 'beginner' && level >= 2) score -= 20;
                if(history === 'advanced' && level >= 2) score += 15;
            }

            // Safety Checks
            if(s.contra && safeties.includes(s.contra)) {
                score = -9999; warnings.push(`âš ï¸ ç¦å¿Œ: ${safetyLabels[s.contra]}`);
            }
            if(safeties.includes('meds')) {
                if(['omega3','ashwagandha','vit_d','berberine','5htp','tryptophan','ginkgo'].includes(s.id)) {
                    if(takens.includes(s.id)) warnings.push('âš ï¸ è–¬ã¨ã®é£²ã¿åˆã‚ã›ç¢ºèªãŒå¿…è¦');
                    else score = -9999; 
                }
            }
            if(safeties.includes('pill')) {
                 if(['maca','soy_iso','boron'].includes(s.id)) {
                     score -= 50; warnings.push('âš ï¸ ãƒ”ãƒ«ã¨ã®ä½µç”¨ã¯åŒ»å¸«ã«è¦ç›¸è«‡');
                 }
            }
            if(safeties.includes('insomnia') && s.id === 'caffeine') warnings.push('âš ï¸ ä¸çœ æ‚ªåŒ–ãƒªã‚¹ã‚¯');
            if(safeties.includes('hi_bp') && s.id === 'sodium') warnings.push('âš ï¸ è¡€åœ§ä¸Šæ˜‡ãƒªã‚¹ã‚¯');

            if(pains.length > 0) score = score / (1 + (Math.log(pains.length + 1) * 0.5));

            // Lane C Reason (Rejection Reason)
            let rejectReason = "";
            if(score <= -100) rejectReason = "å®‰å…¨ä¸Šã®ç†ç”±/ç¦å¿Œã«ã‚ˆã‚Šé™¤å¤–";
            else if(score < threshold) rejectReason = "ç¾åœ¨ã®æ‚©ã¿ãƒ»ç›®çš„ã¸ã®é–¢é€£æ€§ä½";

            return { ...s, finalScore: score, matchLogs, warnings, rejectReason, isTaken: takens.includes(s.id), calcDose: s.dose(weight) };
        }).filter(x => x !== null);

        const takenItems = results.filter(d => d.isTaken);
        
        // Filter Recommendations
        let recItems = results.filter(d => !d.isTaken && d.finalScore >= threshold);
        if (recItems.length === 0) recItems = results.filter(d => !d.isTaken && d.finalScore > 0);
        recItems.sort((a,b) => b.finalScore - a.finalScore);

        // Filter Rejections (Lane C candidates)
        let rejectedItems = results.filter(d => !d.isTaken && d.finalScore < threshold);
        // Sort rejected: Show Safety Risks first (as info), then highest score rejected
        rejectedItems.sort((a,b) => {
             // prioritize showcasing safety warnings
             if(a.finalScore < -100 && b.finalScore > -100) return -1;
             if(a.finalScore > -100 && b.finalScore < -100) return 1;
             return b.finalScore - a.finalScore;
        });
        const displayRejected = rejectedItems.slice(0, 3); // Top 3 rejected

        document.getElementById('resultArea').style.display = 'block';
        const lA = document.getElementById('laneAContent');
        const lB = document.getElementById('laneBContent');
        const lC = document.getElementById('laneCContent');
        lA.innerHTML = ''; lB.innerHTML = ''; lC.innerHTML = '';

        if(takenItems.length > 0) takenItems.forEach(i => lA.innerHTML += createCard(i, 'a'));
        else lA.innerHTML = '<div style="padding:20px; text-align:center; color:#64748b; background:#f1f5f9; border-radius:8px;">é¸æŠãªã—</div>';

        const displayItems = recItems.slice(0, maxDisplay);
        if(displayItems.length > 0) displayItems.forEach(i => lB.innerHTML += createCard(i, 'b'));
        else lB.innerHTML = '<div style="padding:20px; text-align:center; color:#64748b; background:#f1f5f9; border-radius:8px;">æ¡ä»¶ã«åˆã†ææ¡ˆãŒã‚ã‚Šã¾ã›ã‚“</div>';

        // Lane C
        if(displayRejected.length > 0) displayRejected.forEach(i => lC.innerHTML += createCard(i, 'c'));
        else lC.innerHTML = '<div style="padding:10px; font-size:0.8rem; color:#94a3b8;">ç‰¹è¨˜äº‹é …ãªã—</div>';

        renderTimeline([...takenItems, ...displayItems]);
        window.scrollTo({ top: document.getElementById('resultArea').offsetTop - 20, behavior: 'smooth' });
    }

    function createCard(item, lane) {
        const warnHtml = item.warnings.length > 0 ? 
            `<div style="margin-top:10px; padding:8px; background:#fef2f2; color:#ef4444; border-radius:6px; font-weight:bold; font-size:0.8rem;">${item.warnings.join('<br>')}</div>` : '';
        
        let scoreBadge = '';
        if(lane === 'b') {
            const sc = Math.round(item.finalScore);
            const cl = sc >= 80 ? 'score-high' : (sc >= 50 ? 'score-mid' : 'score-low');
            scoreBadge = `<div class="score-badge ${cl}">${sc}</div>`;
        } else if(lane === 'a') {
            scoreBadge = `<div class="supp-score" style="color:#059669; background:#ecfdf5; font-weight:bold;">ç¶™ç¶šä¸­</div>`;
        } else if(lane === 'c') {
            scoreBadge = `<div class="supp-score" style="color:#64748b;">é™¤å¤–</div>`;
        }

        let reasons = item.matchLogs.length > 0 ? item.matchLogs.join(', ') : 'åŸºç¤/ç›®çš„';
        if(lane === 'c') reasons = `<span style="color:#ef4444;">${item.rejectReason}</span>`;

        const tMap = { pre_workout:'ãƒˆãƒ¬å‰', intra_workout:'ãƒˆãƒ¬ä¸­', post_workout:'ãƒˆãƒ¬å¾Œ', morning:'æœ', with_meal:'é£Ÿå¾Œ', pre_meal:'é£Ÿå‰', before_sleep:'å°±å¯å‰', dinner:'å¤•é£Ÿå¾Œ', anytime:'è‡ªç”±' };
        
        const pubLink = (item.pmid && lane !== 'c') ? `<div style="margin-top:8px; text-align:right; font-size:0.75rem;"><a href="https://pubmed.ncbi.nlm.nih.gov/${item.pmid}/" target="_blank" class="pubmed-link">PubMed Evidence â†—</a></div>` : '';

        return `
            <div class="detail-card card-lane-${lane} ${item.warnings.length > 0 ? 'warning' : ''}">
                <div class="card-top">
                    <div class="supp-name" style="${lane==='c'?'color:#64748b;':''}">${item.name}</div>
                    ${scoreBadge}
                </div>
                <div class="reason-row">ç†ç”±: ${reasons}</div>
                ${lane !== 'c' ? `
                <div class="info-row" style="margin-top:5px;"><span class="info-label">ç›®çš„</span><span class="info-val">${item.pro}</span></div>
                <div class="info-row"><span class="info-label">æ¨å¥¨é‡</span><span class="info-val" style="font-weight:bold;">${item.calcDose}</span></div>
                <div class="info-row"><span class="info-label">æ‘‚å–</span><span class="info-val">${tMap[item.timing]||item.timing}</span></div>
                ` : ''}
                ${warnHtml}
                ${pubLink}
            </div>`;
    }

    function renderTimeline(items) {
        const slots = {};
        const order = ['morning', 'pre_meal', 'with_meal', 'pre_workout', 'intra_workout', 'post_workout', 'dinner', 'before_sleep', 'anytime'];
        order.forEach(k => slots[k] = []);
        const labels = { morning:'æœ', pre_meal:'é£Ÿå‰', with_meal:'é£Ÿå¾Œ', pre_workout:'ãƒˆãƒ¬å‰', intra_workout:'ãƒˆãƒ¬ä¸­', post_workout:'ãƒˆãƒ¬å¾Œ', dinner:'å¤•é£Ÿå¾Œ', before_sleep:'å°±å¯å‰', anytime:'è‡ªç”±' };
        items.forEach(it => { if(slots[it.timing]) slots[it.timing].push(`<span class="supp-pill ${it.isTaken ? 'pill-take' : 'pill-add'}">${it.name}</span>`); });
        const tlDiv = document.getElementById('timeline');
        tlDiv.innerHTML = '';
        order.forEach(k => {
            if(slots[k].length > 0) tlDiv.innerHTML += `<div class="time-slot"><div class="time-label">${labels[k]}</div><div class="time-content">${slots[k].join('')}</div></div>`;
        });
    }

    function copyReport() {
        const lA = document.getElementById('laneAContent').innerText;
        const lB = document.getElementById('laneBContent').innerText;
        const tl = document.getElementById('timeline').innerText.replace(/\n/g, ' ');
        const supervisor = supervisorName ? `ç›£ä¿®: ${supervisorName} ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼` : "";
        const t = `ã€ã‚µãƒ—ãƒªãƒ¡ãƒ³ãƒˆææ¡ˆãƒ¬ãƒãƒ¼ãƒˆã€‘\n${supervisor}\n\n[æ‘‚å–ä¸­ã‚¹ã‚¿ãƒƒã‚¯]\n${lA}\n\n[è¿½åŠ æ¨å¥¨]\n${lB}\n\n[ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«]\n${tl}\n\nâ€»åŒ»ç™‚ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚`;
        navigator.clipboard.writeText(t).then(() => alert('ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'));
    }

    function openShop() { if(trainerShopUrl) window.open(trainerShopUrl, '_blank'); }
</script>
</body>
</html>